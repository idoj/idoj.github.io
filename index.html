
<html>
	<head>
		<title>Dood picker</title>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://rawgit.com/FezVrasta/bootstrap-material-design/master/dist/css/bootstrap-material-design.css" />
		<link rel="stylesheet" href="http://t00rk.github.io/bootstrap-material-datetimepicker/./css/bootstrap-material-datetimepicker.css" />
		<link href='http://fonts.googleapis.com/css?family=Roboto:400,500' rel='stylesheet' type='text/css'>
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
		<script type="text/javascript" src="https://rawgit.com/FezVrasta/bootstrap-material-design/master/dist/js/material.min.js"></script>
		<script type="text/javascript" src="http://momentjs.com/downloads/moment-with-locales.min.js"></script>
		<script type="text/javascript" src="http://t00rk.github.io/bootstrap-material-datetimepicker/./js/bootstrap-material-datetimepicker.js"></script>

		<style>
			body 
			{
				padding-top: 70px;
				font-family: 'Roboto', sans-serif;
			}
			h2 
			{
				padding: 0 20px 10px 20px;
				font-size: 20px;
				font-weight: 400;
			}
			.form-control-wrapper 
			{
				margin: 10px 20px;
			}
			code 
			{
				padding: 10px;
				background: #eee!important;
				display: block;
				color: #000;
			}
			code > p 
			{
				font-weight: bold;
				color: #000;
				font-size: 1.5em;
			}
			@media(max-width: 300px)
			{
				.well { margin : 0}
			}

.clockdiv{
    font-family: sans-serif;
    color: #fff;
    display: inline-block;
    font-weight: 100;
    text-align: center;
    font-size: 30px;
}

.clockdiv > div{
    padding: 10px;
    border-radius: 3px;
    background: #00BF96;
    display: inline-block;
}

.clockdiv div > span{
    padding: 15px;
    border-radius: 3px;
    background: #00816A;
    display: inline-block;
}

		</style>
	</head>
	<body>
		<div class="container well">
			<div class="row">
				<div class="col-md-6">
					<h1>Dood</h1>
				</div>
			</div>
		</div>
		<div class="container well" id="page_start">
			<div class="row">
				<div class="col-md-6">
					<h2>Heater control:</h2>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<div class="form-control-wrapper">
						<input type="text" id="long" class="form-control floating-label" placeholder="How long (minutes)">
						<input type="text" id="time" class="form-control floating-label" placeholder="When">
						<button type="button" id="now" class="btn btn-default">Now</button>
						<button type="button" id="start" class="btn btn-success">Set</button>
					</div>
				</div>
				<div class="col-md-6">
					<code>
						<p>Settings</p>
						Enter duration and press 'now' to start heater now or enter start time and then press 'set';<br/><br/>
						- Hour handle in duration selection is ignored.
					</code>
				</div>
			</div>
		</div>
		<div class="container well" id="page_when">
			<div class="row">
				<div class="col-md-6">
					<h2>Due to start in:</h2>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
<div class="clockdiv" id="clockdiv">
  <div>
    <span class="hours"></span>
    <div class="smalltext">Hours</div>
  </div>
  <div>
    <span class="minutes"></span>
    <div class="smalltext">Minutes</div>
  </div>
  <div>
    <span class="seconds"></span>
    <div class="smalltext">Seconds</div>
  </div>
</div>
					<div class="form-control-wrapper">
						<input type="text" id="time2" class="form-control floating-label" placeholder="When" disabled>
						<input type="text" id="long2" class="form-control floating-label" placeholder="How long" disabled>
						<button type="button" id="cancel" class="btn btn-danger">Cancel</button>
					</div>
				</div>
				<div class="col-md-6">
					<code>
						<p>Timer</p>
						This is when heating will start.
					</code>
				</div>
			</div>
		</div>
		<div class="container well" id="page_countdown">
			<div class="row">
				<div class="col-md-6">
					<h2>Heating duration left:</h2>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
<div class="clockdiv" id="clockdiv2">
  <div>
    <span class="hours"></span>
    <div class="smalltext">Hours</div>
  </div>
  <div>
    <span class="minutes"></span>
    <div class="smalltext">Minutes</div>
  </div>
  <div>
    <span class="seconds"></span>
    <div class="smalltext">Seconds</div>
  </div>
</div>
					<div class="form-control-wrapper">
						<button type="button" id="cancel2" class="btn btn-danger">Cancel</button>
					</div>
				</div>
				<div class="col-md-6">
					<code>
						<p>Get ready, Set..</p>
						Go! The water is getting hot as you read this.
					</code>
				</div>
			</div>
		</div>
		<script type="text/javascript">


function getTimeRemaining(endtime) {
  var t = Date.parse(endtime) - Date.parse(new Date());
  var seconds = Math.floor((t / 1000) % 60);
  var minutes = Math.floor((t / 1000 / 60) % 60);
  var hours = Math.floor((t / (1000 * 60 * 60)) % 24);
  return {
    'total': t,
    'hours': hours,
    'minutes': minutes,
    'seconds': seconds
  };
}

function initializeClock(id, endtime) {
  var clock = document.getElementById(id);
  var hoursSpan = clock.querySelector('.hours');
  var minutesSpan = clock.querySelector('.minutes');
  var secondsSpan = clock.querySelector('.seconds');

  function updateClock() {
    if($(hoursSpan).is(":visible") == false)
      clearInterval(timeinterval);

    var t = getTimeRemaining(endtime);

    hoursSpan.innerHTML = ('0' + t.hours).slice(-2);
    minutesSpan.innerHTML = ('0' + t.minutes).slice(-2);
    secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

    if (t.total <= 0) {
      clearInterval(timeinterval);
    }
  }

  updateClock();
  var timeinterval = setInterval(updateClock, 1000);
}



function parseTime(str) {
  var d = new Date();
  var time = str.match(/(\d+)(?::(\d\d))?\s*(p?)/);
  d.setHours( parseInt(time[1]) + (time[3] ? 12 : 0) );
  d.setMinutes( parseInt(time[2]) || 0 );
  d.setSeconds(0);
  return d;
}
function timeDiffNow(date2) {
var now = new Date();

// the following is to handle cases where the times are on the opposite side of
// midnight e.g. when you want to get the difference between 9:00 PM and 5:00 AM
if (date2 < now) {
    date2.setDate(date2.getDate() + 1);
}

return date2 - now;
}

toHHMMSS = function (seconds) {
    var sec_num = parseInt(seconds, 10);
    var hours   = Math.floor(sec_num / 3600);
    var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
    var seconds = sec_num - (hours * 3600) - (minutes * 60);

    if (hours   < 10) {hours   = "0"+hours;}
    if (minutes < 10) {minutes = "0"+minutes;}
    if (seconds < 10) {seconds = "0"+seconds;}
    var time    = hours+':'+minutes+':'+seconds;
    return time;
}

function showHHMM(time) {
	return ("0" + time.getHours()).slice(-2)   + ":" + 
    ("0" + time.getMinutes()).slice(-2) + ":" + 
    ("0" + time.getSeconds()).slice(-2);
}

function flippages() {
	$.getJSON(url, {'j': 0}).done(function(data) {
			if (data.onat_long != null) {
			$('#page_start').hide();
			$('#page_countdown').hide();
			$('#page_when').show();
			now = new Date();
			now.setTime(now.getTime() + 1000 * (data.onat_when - data.now));
			$('#time2').val(showHHMM(now));
			$('#long2').val(toHHMMSS(data.onat_long - data.onat_when));
			initializeClock('clockdiv', now);
			} else if (data.on_until != null) { 
			$('#page_start').hide();
			$('#page_countdown').show();
			$('#page_when').hide();
			var deadline = new Date(Date.parse(new Date()) + (data.on_until - data.now) * 1000);
			initializeClock('clockdiv2', deadline);
			} else {
			$('#page_start').show();
			$('#page_countdown').hide();
			$('#page_when').hide();
			var d = new Date();
			$('#time').val(showHHMM(d));
			$('#long').val(20);
			}
	});
}

		var url = "http://192.168.1.3/";
		$(document).ready(function() {
		flippages();

function start(when, long) {
	j = JSON.stringify({'when': when, 'long': long});
	$.getJSON(url, {'j' : j}).done(function(data) { $('#time').val(data.err); if (data.err != 0) alert(data.err); flippages(); });
}
function cancel() {
	j = JSON.stringify({'cancel': 1});
	$.getJSON(url, {'j' : j}).done(function(data) { $('#time').val(data.err); if (data.err != 0) alert(data.err); flippages(); });
}

			$('#cancel').click(function() { cancel(); });
			$('#cancel2').click(function() { cancel(); });
			$('#now').click(function() { start(0, $('#long').val() * 60); });
			$('#start').click(function() { 
				var date2 = parseTime($('#time').val());
				when = Math.floor(timeDiffNow(date2)/1000);
				if (when / 3600 > 23.5) {
					when = 0;
					alert('starting now..');
				}
				start(when, $('#long').val() * 60);
			});
			$('#time').bootstrapMaterialDatePicker
			({
				date: false,
				shortTime: false,
				format: 'HH:mm'
			});
			$('#long').bootstrapMaterialDatePicker
			({
				date: false,
				shortTime: false,
				format: 'mm'
			});

			$.material.init()
		});
		</script>
	</body>
</html>
